name: Build Installers (Windows, macOS, Linux)

on:
  push:
    tags:
      - "v*"

jobs:
  build-linux:
    name: Build Linux Installer (.deb)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Dependencies
        run: sudo apt-get update && sudo apt-get install -y fakeroot rpm

      - name: Set Up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Build JAR with Maven
        run: mvn -B package --file pom.xml

      - name: Create Runtime (jlink)
        run: |
          rm -rf runtime
          jlink \
            --add-modules java.desktop,java.sql,java.logging \
            --output runtime

      - name: Build Linux Installer (.deb)
        run: |
          jpackage \
            --name InventoryApp \
            --input target \
            --main-jar InventoryApp-1.0-jar-with-dependencies.jar \
            --main-class src.Main \
            --type deb \
            --runtime-image runtime \
            --app-version ${{ github.ref_name }}

      - name: Upload Linux Installer
        uses: actions/upload-artifact@v4
        with:
          name: InventoryApp-linux
          path: InventoryApp*.deb


  build-windows:
    name: Build Windows Installer (.exe)
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set Up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Build JAR with Maven
        run: mvn -B package --file pom.xml

      - name: Create Runtime (jlink)
        shell: cmd
        run: |
          if exist runtime rmdir /s /q runtime
          jlink ^
            --add-modules java.desktop,java.sql,java.logging ^
            --output runtime

      - name: Build Windows Installer (.exe)
        shell: cmd
        run: |
          jpackage ^
            --name InventoryApp ^
            --input target ^
            --main-jar InventoryApp-1.0-jar-with-dependencies.jar ^
            --main-class src.Main ^
            --type exe ^
            --runtime-image runtime ^
            --app-version ${{ github.ref_name }}

      - name: Upload Windows Installer
        uses: actions/upload-artifact@v4
        with:
          name: InventoryApp-windows
          path: InventoryApp*.exe


  build-macos:
    name: Build macOS Installer (.dmg)
    runs-on: macos-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set Up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Build JAR with Maven
        run: mvn -B package --file pom.xml

      - name: Create Runtime (jlink)
        run: |
          rm -rf runtime
          jlink \
            --add-modules java.desktop,java.sql,java.logging \
            --output runtime

      - name: Build macOS Installer (.dmg)
        run: |
          jpackage \
            --name InventoryApp \
            --input target \
            --main-jar InventoryApp-1.0-jar-with-dependencies.jar \
            --main-class src.Main \
            --type dmg \
            --runtime-image runtime \
            --app-version ${{ github.ref_name }}

      - name: Upload macOS Installer
        uses: actions/upload-artifact@v4
        with:
          name: InventoryApp-macos
          path: InventoryApp*.dmg

